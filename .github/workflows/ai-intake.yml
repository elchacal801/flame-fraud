on:
  issues:
    types: [opened, labeled]

jobs:
  generate:
    # Only run when the intel-submission label is applied AND the author is a trusted collaborator.
    # The author_association gate prevents untrusted users from triggering workflows that
    # have access to secrets (ANTHROPIC_API_KEY, OPENAI_API_KEY, GITHUB_TOKEN).
    if: >
      contains(github.event.issue.labels.*.name, 'intel-submission') &&
      contains(fromJSON('["OWNER","MEMBER","COLLABORATOR"]'), github.event.issue.author_association)
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install pyyaml requests beautifulsoup4

      - name: Parse issue body
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || '';

            // Extract fields from the issue form
            function extractField(body, label) {
              // Issue forms render as: ### Label\n\nValue
              const regex = new RegExp(`### ${label}\\s*\\n+([\\s\\S]*?)(?=\\n### |$)`, 'i');
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            }

            const sourceUrl = extractField(body, 'Intel Source URL');
            const submissionType = extractField(body, 'Submission Type');
            const crafterName = extractField(body, 'Your Name or Handle');
            const additionalContext = extractField(body, 'Additional Context \\(optional\\)');
            const sector = extractField(body, 'Primary Sector');

            // Parse fraud types from checkboxes
            const fraudSection = extractField(body, 'Fraud Types \\(select all that apply\\)');
            const fraudTypes = [];
            const checkboxRegex = /- \[X\] (.+)/gi;
            let m;
            while ((m = checkboxRegex.exec(fraudSection)) !== null) {
              // Convert display names to kebab-case slugs
              const raw = m[1].trim();
              const slug = raw.toLowerCase()
                .replace(/[()\/]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .replace(/-$/, '');
              fraudTypes.push(slug);
            }

            // Validate required fields
            if (!sourceUrl || sourceUrl === '_No response_') {
              core.setFailed('No source URL found in issue body');
              return;
            }

            core.setOutput('source_url', sourceUrl);
            core.setOutput('author', crafterName || 'FLAME AI Intake');
            core.setOutput('sector', sector.toLowerCase().replace(/\s+/g, '-') || 'cross-sector');
            core.setOutput('fraud_types', fraudTypes.join(',') || '');
            core.setOutput('context', additionalContext === '_No response_' ? '' : additionalContext);

      # SECURITY FIX: All step outputs are passed via env: block instead of ${{ }} in run:
      # to prevent shell injection from user-controlled issue body fields.
      - name: Run AI intake
        id: intake
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          INPUT_SOURCE_URL: ${{ steps.parse.outputs.source_url }}
          INPUT_AUTHOR: ${{ steps.parse.outputs.author }}
          INPUT_SECTOR: ${{ steps.parse.outputs.sector }}
          INPUT_FRAUD_TYPES: ${{ steps.parse.outputs.fraud_types }}
          INPUT_CONTEXT: ${{ steps.parse.outputs.context }}
        run: |
          OUTPUT=$(python scripts/ai_intake.py \
            --url "$INPUT_SOURCE_URL" \
            --author "$INPUT_AUTHOR" \
            --sector "$INPUT_SECTOR" \
            --fraud-types "$INPUT_FRAUD_TYPES" \
            --context "$INPUT_CONTEXT")

          echo "intake_json=$OUTPUT" >> $GITHUB_OUTPUT

          # Extract fields from JSON
          FILEPATH=$(echo "$OUTPUT" | python -c "import sys,json; print(json.load(sys.stdin)['filepath'])")
          TITLE=$(echo "$OUTPUT" | python -c "import sys,json; print(json.load(sys.stdin)['title'])")
          TP_ID=$(echo "$OUTPUT" | python -c "import sys,json; print(json.load(sys.stdin)['tp_id'])")
          MODEL=$(echo "$OUTPUT" | python -c "import sys,json; print(json.load(sys.stdin)['model'])")

          echo "filepath=$FILEPATH" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "tp_id=$TP_ID" >> $GITHUB_OUTPUT
          echo "model=$MODEL" >> $GITHUB_OUTPUT

      - name: Validate generated file
        id: validate
        env:
          INTAKE_FILEPATH: ${{ steps.intake.outputs.filepath }}
        run: |
          python scripts/validate_submission.py "$INTAKE_FILEPATH" && echo "valid=true" >> $GITHUB_OUTPUT || echo "valid=false" >> $GITHUB_OUTPUT

      - name: Create labels if missing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh label create "ai-generated" --color "8a2be2" --description "Generated by FLAME AI" || true
          gh label create "needs-review" --color "d93f0b" --description "Pending maintainer review" || true

      - name: Create branch and PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          INTAKE_TP_ID: ${{ steps.intake.outputs.tp_id }}
          INTAKE_TITLE: ${{ steps.intake.outputs.title }}
          INTAKE_MODEL: ${{ steps.intake.outputs.model }}
          INTAKE_FILEPATH: ${{ steps.intake.outputs.filepath }}
          PARSE_SOURCE_URL: ${{ steps.parse.outputs.source_url }}
          VALIDATE_VALID: ${{ steps.validate.outputs.valid }}
        run: |
          BRANCH="ai-intake/issue-${ISSUE_NUMBER}"
          TP_ID="$INTAKE_TP_ID"
          TITLE="$INTAKE_TITLE"
          MODEL="$INTAKE_MODEL"
          SOURCE_URL="$PARSE_SOURCE_URL"
          VALID="$VALIDATE_VALID"
          ISSUE_NUM="$ISSUE_NUMBER"
          FILEPATH="$INTAKE_FILEPATH"

          git config user.name "FLAME AI Intake"
          git config user.email "flame-ai@users.noreply.github.com"

          git checkout -b "$BRANCH"
          git add "$FILEPATH"
          git commit -m "feat: Add ${TP_ID} â€” ${TITLE} (AI-generated)

          Source: ${SOURCE_URL}
          Model: ${MODEL}
          Issue: #${ISSUE_NUM}"

          git push -f origin "$BRANCH"

          # Build PR body
          VALIDATION_STATUS="passed"
          if [ "$VALID" = "false" ]; then
            VALIDATION_STATUS="**failed** (manual review required)"
          fi

          PR_BODY="## AI-Generated Threat Path

          | Field | Value |
          |-------|-------|
          | **Source** | ${SOURCE_URL} |
          | **Model** | \`${MODEL}\` |
          | **TP ID** | ${TP_ID} |
          | **Validation** | ${VALIDATION_STATUS} |
          | **Triggered by** | #${ISSUE_NUM} |

          ---

          > This threat path was automatically generated by the FLAME AI intake pipeline.
          > Please review the content for accuracy, completeness, and quality before merging.
          > Pay special attention to CFPF phase mappings and MITRE ATT&CK technique references."

          gh pr create \
            --title "[AI Intake] ${TP_ID}: ${TITLE}" \
            --body "$PR_BODY" \
            --base main \
            --head "$BRANCH" \
            --label "ai-generated,needs-review"

      # SECURITY FIX: Step outputs accessed via process.env instead of ${{ }} interpolation
      # in github-script to prevent JavaScript injection from user-controlled values.
      - name: Comment on issue
        uses: actions/github-script@v7
        env:
          INTAKE_TP_ID: ${{ steps.intake.outputs.tp_id }}
          INTAKE_TITLE: ${{ steps.intake.outputs.title }}
          INTAKE_MODEL: ${{ steps.intake.outputs.model }}
          VALIDATE_VALID: ${{ steps.validate.outputs.valid }}
        with:
          script: |
            const tpId = process.env.INTAKE_TP_ID;
            const title = process.env.INTAKE_TITLE;
            const model = process.env.INTAKE_MODEL;
            const valid = process.env.VALIDATE_VALID;
            const branch = `ai-intake/issue-${context.payload.issue.number}`;

            let comment = `### FLAME AI Intake Complete\n\n`;
            comment += `| Field | Value |\n|-------|-------|\n`;
            comment += `| **TP ID** | ${tpId} |\n`;
            comment += `| **Title** | ${title} |\n`;
            comment += `| **Model** | \`${model}\` |\n`;
            comment += `| **Validation** | ${valid === 'true' ? 'Passed' : 'Failed (manual fixes needed)'} |\n\n`;
            comment += `A pull request has been created on branch \`${branch}\` for maintainer review.\n\n`;
            comment += `> The generated threat path should be reviewed for accuracy before merging.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: comment
            });
